<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Manage Saloon</title>

  <!-- Bootstrap CSS -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    /* Slide-in form sidebar */
    .sidebar-form {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: #fff;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
      z-index: 1050;
      transition: right 0.3s ease;
      overflow-y: auto;
    }

    .sidebar-form.active {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <%- include('header') %>

  <!-- Sidebar -->
  <%- include('sidebar') %>

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Manage Saloon</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/home">Home</a></li>
          <li class="breadcrumb-item active">Manage Saloon</li>
        </ol>
      </nav>
      <div class="mb-3">
        <button class="btn btn-primary" id="open-saloon-form">Add Saloon</button>
      </div>
    </div>

    <section class="section dashboard">
      <div class="row" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
        <!-- Saloon List -->
        <div class="">
          <div class="card recent-sales">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">Saloon List</h5>
            </div>
            <div class="card-body">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Owner Name</th>
                    <th>Pincode</th>
                    <th>Address</th>
                    <th>Email</th>
                    <th>Gender Served</th>

                    <th>State</th>
                    <th>District</th>
                    <th>City</th>
                    <th>Phone</th>
                    <th>Image</th>
                    <th>Created At</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="saloonTableBody">
                  <tr>
                    <td colspan="11" class="text-center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Add/Edit Saloon Sidebar Form -->
      <div id="saloon-form-sidebar" class="sidebar-form">
        <div class="sidebar-header">
          <h5>Add New Saloon</h5>
          <button type="button" class="btn-close" id="close-saloon-form"></button>
        </div>
        <form id="add-saloon-form" class="p-3">
          <div class="mb-3">
            <label for="saloon-name" class="form-label">Saloon Name</label>
            <input type="text" class="form-control" id="saloon-name" required>
          </div>
          <div class="mb-3">
            <label for="saloon-address" class="form-label">Address</label>
            <input type="text" class="form-control" id="saloon-address" required>
          </div>
          <div class="mb-3">
            <label for="saloon-email" class="form-label">Email</label>
            <input type="email" class="form-control" id="saloon-email" required>
          </div>
          <div class="mb-3">
            <label for="saloon-pincode" class="form-label">Pincode</label>
            <input type="number" class="form-control" id="saloon-pincode" required>
          </div>
          <div class="mb-3">
  <label for="saloon-gender" class="form-label">Gender Served</label>
  <select class="form-select" id="saloon-gender" required>
    <option value="">Select Gender</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
    <option value="unisex">Both</option>
  </select>
</div>

          <div class="mb-3">
            <label for="state-select" class="form-label">State</label>
            <select class="form-select" id="state-select" required>
              <option value="">Select State</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="district-select" class="form-label">District</label>
            <select class="form-select" id="district-select" required>
              <option value="">Select District</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="saloon-city" class="form-label">City</label>
            <input type="text" class="form-control" id="saloon-city" required>
          </div>
          <div class="mb-3">
            <label for="saloon-phone" class="form-label">Phone</label>
            <input type="text" class="form-control" id="saloon-phone" required>
          </div>
          <div class="mb-3">
  <label for="saloon-image" class="form-label">Image</label>
  <input type="file" class="form-control" id="saloon-image" name="image" accept="image/*">
</div>

          <button type="submit" class="btn btn-success">Save Saloon</button>
        </form>
      </div>


<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p id="successMessage"></p>
        <button type="button" class="btn btn-success mt-2" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p>Are you sure you want to delete this saloon?</p>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>



    </section>
  </main>

  <!-- Footer -->
  <%- include('footer') %>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const sidebarForm = document.getElementById('saloon-form-sidebar');
    const openFormBtn = document.getElementById('open-saloon-form');
    const closeFormBtn = document.getElementById('close-saloon-form');
    const stateSelect = document.getElementById('state-select');
    const districtSelect = document.getElementById('district-select');
const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    let deleteId = null;


    openFormBtn.addEventListener('click', () => {
      sidebarForm.classList.add('active');
      document.getElementById('add-saloon-form').reset();
      document.getElementById('add-saloon-form').removeAttribute('data-id');
      document.querySelector('#saloon-form-sidebar h5').innerText = 'Add New Saloon';
      document.querySelector('#add-saloon-form button[type="submit"]').innerText = 'Save Saloon';
      fetchStates();
    });

    closeFormBtn.addEventListener('click', () => {
      sidebarForm.classList.remove('active');
      document.getElementById('add-saloon-form').reset();
      document.getElementById('add-saloon-form').removeAttribute('data-id');
    });

    // Fetch Saloons
    async function loadSaloons() {
      try {
        const res = await fetch('/saloon/getAllSaloons');
        const data = await res.json();
        
        
        const tbody = document.getElementById('saloonTableBody');
        tbody.innerHTML = '';
        if (data.length > 0) {
          data.forEach((saloon, index) => {
            tbody.innerHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${saloon.name}</td>
                <td>${saloon.pincode}</td>
                <td>${saloon.address}</td>
                <td>${saloon.email}</td>
                <td>${saloon?.gender_served || '-'}</td>

                <td>${saloon.state_name}</td>
                <td>${saloon.district_name}</td>
                <td>${saloon?.city}</td>
                <td>${saloon.phone}</td>
                <td><img src="/uploads/${saloon.image}" width="60" height="60" style="object-fit:cover;"></td>
                <td>${saloon.created_at}</td>
                
                <td>
                  <button class="btn btn-sm btn-primary edit-btn" data-id="${saloon.salon_id}">Edit</button>
                </td>
                <td>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${saloon.salon_id}">Delete</button>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="11" class="text-center">No saloons found</td></tr>';
        }
      } catch (err) {
        console.error(err);
      }
    }

    loadSaloons();

    // State & District Dropdown
    async function fetchStates() {
      try {
        const res = await fetch('/saloon/getstates');
        const states = await res.json();
        stateSelect.innerHTML = `<option value="">Select State</option>`;
        states.states.forEach(state => {
          stateSelect.innerHTML += `<option value="${state.state_id}">${state.name}</option>`;
        });
        districtSelect.innerHTML = `<option value="">Select District</option>`;
      } catch (err) {
        console.error(err);
      }
    }

    stateSelect.addEventListener('change', async () => {
      const stateId = stateSelect.value;
      if (!stateId) {
        districtSelect.innerHTML = `<option value="">Select District</option>`;
        return;
      }
      try {
        const res = await fetch(`/saloon/getstates`);
        const districts = await res.json();
console.log("dis",res);

        districtSelect.innerHTML = `<option value="">Select District</option>`;
        districts.districts.forEach(d => {
          districtSelect.innerHTML += `<option value="${d.district_id}">${d.name}</option>`;
        });
      } catch (err) {
        console.error(err);
      }
    });

    // Edit Saloon
    document.getElementById('saloonTableBody').addEventListener('click', async (e) => {
      if (e.target.classList.contains('edit-btn')) {
        const saloonId = e.target.getAttribute('data-id');
        try {
          const res = await fetch(`/saloon/getbyid/${saloonId}`);
          let saloon = await res.json();
          console.log("sd",saloon);
          


          document.getElementById('saloon-name').value = saloon.saloon.name;
          document.getElementById('saloon-address').value = saloon.saloon.address;
          document.getElementById('saloon-phone').value = saloon.saloon.phone;
          document.getElementById('saloon-pincode').value = saloon.saloon.pincode;
          document.getElementById('saloon-city').value = saloon.saloon.city;
          document.getElementById('saloon-email').value = saloon.saloon.email;
          document.getElementById('saloon-gender').value = saloon.saloon.gender_served;

          stateSelect.value = saloon.saloon.state_id;

          // Load districts
          const resDistricts = await fetch(`/saloon/getstates`);
          const districts = await resDistricts.json();
          console.log(districts);
          
          
          
          districtSelect.innerHTML = `<option value="">Select District</option>`;
          districts.districts.forEach(d => {
            districtSelect.innerHTML += `<option value="${d.district_id}" ${d.district_id == saloon.district_id ? 'selected' : ''}>${d.name}</option>`;
          });
          stateSelect.innerHTML = `<option value="">Select State</option>`;
        districts.states.forEach(state => {
          stateSelect.innerHTML += `<option value="${state.state_id}">${state.name}</option>`;
        });
        districtSelect.innerHTML = `<option value="">Select District</option>`;

          sidebarForm.classList.add('active');
          document.getElementById('add-saloon-form').setAttribute('data-id', saloonId);
          document.querySelector('#saloon-form-sidebar h5').innerText = 'Edit Saloon';
          document.querySelector('#add-saloon-form button[type="submit"]').innerText = 'Update Saloon';

        } catch (err) {
          console.error(err);
          alert('Error fetching saloon data');
        }
      }
    });

    // Submit Form (Add/Update)
   document.getElementById('add-saloon-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const saloonId = e.target.getAttribute('data-id');
  
  const formData = new FormData();
  formData.append("name", document.getElementById('saloon-name').value);
  formData.append("address", document.getElementById('saloon-address').value);
  formData.append("phone", document.getElementById('saloon-phone').value);
  formData.append("pincode", document.getElementById('saloon-pincode').value);
  formData.append("city", document.getElementById('saloon-city').value);
  formData.append("email", document.getElementById('saloon-email').value);
  formData.append("state_id", stateSelect.value);
  formData.append("district_id", districtSelect.value);
formData.append("gender_served", document.getElementById('saloon-gender').value);

  const imageFile = document.getElementById('saloon-image').files[0];
  if (imageFile) formData.append("image", imageFile);

  try {
    const url = saloonId ? `/saloon/update/${saloonId}` : '/saloon/add';
    const method = saloonId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      body: formData
    });

    const result = await res.json();
    if (result.success) {
      sidebarForm.classList.remove('active');
      e.target.reset();
      e.target.removeAttribute('data-id');
      document.querySelector('#saloon-form-sidebar h5').innerText = 'Add New Saloon';
      document.querySelector('#add-saloon-form button[type="submit"]').innerText = 'Save Saloon';

       document.getElementById('successMessage').innerText = saloonId ? "Saloon updated successfully!" : "Saloon added successfully!";
          successModal.show();


      loadSaloons();
      
    } else {
      alert('Error saving saloon');
    }
  } catch (err) {
    console.error(err);
    alert('Error saving saloon');
  }
});



    // Delete Saloon
   document.getElementById('saloonTableBody').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        deleteId = e.target.getAttribute('data-id');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
      }
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (!deleteId) return;
      try {
        const res = await fetch(`/saloon/delete/${deleteId}`, { method: "DELETE" });
        const result = await res.json();
        if (result.success) {
          const deleteModalEl = document.getElementById('deleteModal');
          const modalInstance = bootstrap.Modal.getInstance(deleteModalEl);
          modalInstance.hide();

          document.getElementById('successMessage').innerText = "Saloon deleted successfully!";
          successModal.show();
          loadSaloons();
        }
      } catch (err) {
        console.error(err);
      }
    });








  </script>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
</body>
</html>
